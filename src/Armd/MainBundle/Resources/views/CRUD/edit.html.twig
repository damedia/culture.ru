{#

This file is part of the Sonata package.

(c) Thomas Rabaix <thomas.rabaix@sonata-project.org>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends 'SonataAdminBundle:CRUD:edit.html.twig' %}


{% block actions %}
    <div class="sonata-actions">
        {% if admin.hasroute('show') and admin.id(object) and admin.isGranted('VIEW', object) and admin.show|length > 0 %}
            <a class="btn sonata-action-element" href="{{ admin.generateObjectUrl('show', object) }}">
                <i class="icon-zoom-in"></i>
                {{ 'link_action_show'|trans({}, 'SonataAdminBundle') }}</a>
                
            {% if (has_change_history(object)) %}    
                <a class="btn sonata-action-element view-history" href="{{ path('ru__RG__admin_armd_main_changehistory_list', { 'entity_id' : admin.id(object), 'entity_class' : object.className }) }}">
                    <i class="icon-zoom-in"></i>
                    {{ 'link_action_view_history'|trans({}, 'SonataAdminBundle') }}</a>
            {% endif %}                   
            
        {% endif %}
        {% if admin.hasroute('history') and admin.id(object) and admin.isGranted('EDIT', object) %}
            <a class="btn sonata-action-element" href="{{ admin.generateObjectUrl('history', object) }}">
                <i class="icon-book"></i>
                {{ 'link_action_history'|trans({}, 'SonataAdminBundle') }}</a>
        {% endif %}
        {% include 'SonataAdminBundle:Core:create_button.html.twig' %}
        {% if admin.hasroute('list') and admin.isGranted('LIST')%}
            <a class="btn sonata-action-element" href="{{ admin.generateUrl('list') }}">
                <i class="icon-list"></i>
                {{ 'link_action_list'|trans({}, 'SonataAdminBundle') }}</a>
        {% endif %}
    </div>
{% endblock %}

{% block form %}

    {% if (has_change_history(object)) %}
 
        <div id="history-list" style="display:none;"></div>
        <div id="history-view" style="display:none;"></div>
        
    {% endif %}
    
    {{ block('parentForm') }}
    
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(function(){
           
            $('a.view-history').on('click', function(){
                $('#history-list').load($(this).attr('href'), function(responseText, textStatus, XMLHttpRequest){
                    $('#history-list').show('slow');
                });
                return false;
            });
            
            $('#history-list').on('click', 'a.hide-history', function(){
                $(this).closest('#history-list').hide('slow', function(){
                    $(this).html(null);
                });
                return false;                 
            });
            
            $('#history-list').on('click', 'a.view_link', function(){
                
                $.post($(this).attr('href'), function(data, textStatus, jqXHR){
                    $('#history-view').html(data);
                    $('#history-view').dialog({width: 800, closeOnEscape: true});
                });
                return false;
            });
            
            $('#history-list').on('click', '.pagination a', function(){
                var t = $(this).attr('href').split('?'),
                    query_param = (t.length > 1) ? t[1].split('&') : null,
                    page = 1,
                    per_page = 0;

                if (query_param.length > 0)
                {
                    for (var i=0; i<query_param.length; i++)
                    {
                        var param = query_param[i].split('=');
                        if (param[0] == 'filter%5B_page%5D')
                            page = param[1];
                        else if (param[0] == 'filter%5B_per_page%5D')
                            per_page = param[1];
                    }
                }
                $('#history-list').load($('a.view-history').attr('href')+'&filter[_page]='+page+'&filter[_per_page]='+per_page);
                return false;            
            });
            
        });
    
    </script>    
{% endblock %}    
